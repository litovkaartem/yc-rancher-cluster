---
- name: Установка RKE2 на SN (master)
  hosts: sn
  become: yes

  tasks:
    - name: 1. Установить RKE2
      shell: curl -sfL https://get.rke2.io | sh -
    
    - name: 2. Добавить /opt/rke2/bin в PATH
      lineinfile:
        path: /home/alitowka/.bashrc
        line: 'export PATH=$PATH:/opt/rke2/bin'
    
    - name: 3. Включить и запустить RKE2 сервер
      systemd:
        name: rke2-server
        enabled: yes
        state: started
    
    - name: 4. Подождать запуска RKE2 (60 секунд)
      pause:
        seconds: 60
    
    - name: 5. Проверить что RKE2 запустился
      shell: systemctl is-active rke2-server
      register: rke2_status
      failed_when: rke2_status.stdout != "active"
    
    - name: 6. Создать симлинк для kubectl
      file:
        src: /var/lib/rancher/rke2/bin/kubectl
        dest: /usr/bin/kubectl
        state: link
        force: yes
    
    - name: 7. Создать .kube директорию
      file:
        path: /home/alitowka/.kube
        state: directory
        owner: alitowka
        group: alitowka
    
    - name: 8. Подождать создания kubeconfig
      wait_for:
        path: /etc/rancher/rke2/rke2.yaml
        timeout: 30
    
    - name: 9. Создать симлинк для kubeconfig
      file:
        src: /etc/rancher/rke2/rke2.yaml
        dest: /home/alitowka/.kube/config
        state: link
        owner: alitowka
        group: alitowka
    
    - name: 10. Получить node-token
      shell: cat /var/lib/rancher/rke2/server/node-token
      register: node_token
      changed_when: false
    
    - name: 11. Получить внутренний IP SN
      shell: hostname -I | awk '{print $1}'
      register: sn_internal_ip
      changed_when: false
    
    - name: 12. Показать полученные данные
      debug:
        msg: |
          Node Token: {{ node_token.stdout }}
          Internal IP: {{ sn_internal_ip.stdout }}

- name: Установка RKE2 агента на WN (worker)
  hosts: wn
  become: yes

  tasks:
    - name: 1. Установить RKE2 агент
      shell: curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="agent" sh -
    
    - name: 2. Включить сервис агента
      systemd:
        name: rke2-agent
        enabled: yes
        state: stopped
    
    - name: 3. Создать директорию конфига
      file:
        path: /etc/rancher/rke2
        state: directory
    
    - name: 4. Получить токен и IP с SN
      set_fact:
        rke2_token: "{{ hostvars['sn1']['node_token']['stdout'] }}"
        sn_ip: "{{ hostvars['sn1']['sn_internal_ip']['stdout'] }}"
    
    - name: 5. Создать конфиг файл
      copy:
        dest: /etc/rancher/rke2/config.yaml
        content: |
          server: https://{{ sn_ip }}:9345
          token: {{ rke2_token }}
        owner: root
        group: root
        mode: '0644'
    
    - name: 6. Запустить RKE2 агент
      systemd:
        name: rke2-agent
        state: started
    
    - name: 7. Проверить статус агента
      shell: systemctl status rke2-agent --no-pager
      register: agent_status
    
    - name: 8. Показать статус
      debug:
        msg: "{{ agent_status.stdout_lines }}"

- name: Установка docker и запуск Rancher Server
  hosts: rancher
  become: yes

  tasks:
    - name: 1. Установить Docker
      apt:
        name:
          - docker.io
          - docker-compose
        state: present
        update_cache: yes
    
    - name: 2. Запустить и включить Docker
      systemd:
        name: docker
        state: started
        enabled: yes
    
    - name: 3. Добавить пользователя в группу docker
      user:
        name: alitowka
        groups: docker
        append: yes

    - name: 4. Проверить, не запущен ли уже rancher
      shell: docker ps -q --filter "name=rancher-server"
      register: rancher_running
      changed_when: false
    
    - name: 5. Запустить Rancher
      shell: |
        docker run -d \
          --restart=unless-stopped \
          --name rancher-server \
          -p 80:80 -p 443:443 \
          --privileged \
          rancher/rancher:latest
      when: rancher_running.stdout == ""
    
    - name: 6. Подождать запуска Rancher (30 секунд)
      wait_for:
        port: 80
        delay: 10
        timeout: 30
      when: rancher_running.stdout == ""
    
    - name: 7. Проверить запущенные контейнеры
      shell: docker ps
      register: containers
    
    - name: 8. Показать статус контейнеров
      debug:
        msg: "{{ containers.stdout_lines }}"
    
    - name: 9. Получить начальный пароль Rancher
      shell: |
        docker logs rancher-server 2>&1 | grep "Bootstrap Password:" | tail -1
      register: rancher_password
      ignore_errors: yes
    
    - name: 10. Показать пароль если найден
      debug:
        msg: "{{ rancher_password.stdout }}"
      when: rancher_password.stdout != ""
